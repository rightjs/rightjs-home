# Работа с Ajax

В целом существует один простой базовый класс с именем {Xhr} который отвечает
за всю обработку ajax функциональности в RightJS

Простой пример выглядит следующим образом

    new Xhr('/some/url').send();
    new Xhr('/some/url').send('param=value');
    new Xhr('/some/url', {onFinish: function() {..}}).send();


## Список опций, :options

Класс {Xhr} поддерживает следующие опции


Имя          | Умолчание | Описание
-------------|-----------|--------------------------------------------------------
method       | ‘post’    | метод запроса
encoding     | ‘utf-8’   | используемая кодировка
async        | true      | флаг асинхронного вызова
evalScripts  | false     | исполнять ли код из JavaScript тэгов из текста ответа
evalResponse | false     | если нужно исполнить текст ответа как код JavaScript
evalJSON     | true      | обрабатывать ли JSON ответы автоматически
secureJSON	 | true	     | флаг, если JSON код должен быть проверяться
urlEncoded   | true      | флаг, если необходимо кодировать отправляемые данные
spinner      | null      | ссылка на элемент спиннера или его ID
spinnerFx    | 'fade'    | визуальный эффект для работы со спиннером
params       | null      | параметры для отправки по умолчанию


Вы можете посылать любые опции вместе с конструктором класса {Xhr}, или же
вы можете изменить настройки глобально, изменив переменную {Xhr.Options}.

    Xhr.Options.spinner = 'global-spinner-id';
    Xhr.Options.params  = 'my=params&global=options';


## Поддерживаемые события, :events

Класс {Xhr} наследует стандартный интерфейс класса {Observer} и работает
со следующими событиями.
  
* create
* request
* complete
* success
* cancel

Вы можете назначать ваши обработчики событий любым стандартным способом.

    new Xhr('/some/url', {onFinish: function() {...}}).send();
    new Xhr('/some/url').on('finish', function() {...}).send();
    new Xhr('/some/url').onFinish(function() {...}).send();
    
    var xhr = new Xhr('/some/url');
    xhr.onComplete(some_function);
    xhr.stopObserving(some_function);

Естественно вы можете работать с собственными событиями тем же способом

    var xhr = new Xhr('/some/url');
    
    xhr.on('my-event', function() {...});
    xhr.checkMyEvent = function() {
      if (this.something) {
        this.fire('my-event');
      }
    };
    
    xhr.onComplete('checkMyEvent');

__ВНИМАНИЕ__: все функции слушателей будут исполнены в контексте объекта запроса
и получат два аргумента: ссылку на текущий объект запроса, и ссылку на оригинальный
XMLHttpRequest объект.

Дополнительно класс {Xhr} имеет интерфейс обсервера уровня класса, который
вы можете использовать для подключения глобальных слушателей событий.

    Xhr.onSend(call_that_function);
    
    new Xhr('/some/url').send(); // <- автоматически вызовет ту функцию


## Обработка спиннеров, :spinners

Класс {Xhr} в RightJS имеет встроенную поддержку работы со спиннерами. Вам не нужно
указывать никакие дополнительные функции, просто укажите ссылку на элемент спиннера
и {Xhr} будет автоматически показывать его и скрывать.

Вы можете указать, как глобальный спиннер, который будет работать со всеми запросами,
так и локальный, который будет срабатывать только для какого-то определенного запроса.

    Xhr.Options.spinner = $('spinner');
    Xhr.Options.spinner = 'global-spinner-id';
    
    // или для конкретного запроса
    new Xhr('/some/url', {spinner: 'custom-spinner'}).send();

__ВНИМАНИЕ__: если вы укажете оба, глобальный и локальный спиннер, оба из них будут
использованы


## Обработка параметров, :parameters

Существует три уровня на которых можно указать данные для отправки на сервер.
Глобальные, уровня объекта запроса, и локальные данные для каждой отправки.

Глобальные данные могут быть установлены в переменной {Xhr.Options} и будут
отправляться с каждым запросом. Данные уровня объекта работают при каждой
отправке запроса из данного объекта. И локальный данные вы можете указать
передать в метод {Xhr#send} для каждой отдельной отправки.

Все они будут собраны в единый кусок данных перед отправкой с приоритетом
данных более низкого уровня.

    Xhr.Options.params = 'my_cite_key=123234';
    
    var xhr = new Xhr('/some/url', {params: 'request=params'});
    
    xhr.send('some_more=params&send=options');

Параметры могут быть в виде url-кодированной строки или в виде хэшей. Хэши
убудут кодироваться автоматически.

    new Xhr('/some.url').send('some=params&more=options');
    
    // или так
    new Xhr('/some.url').send({some: 'params', more: 'options'});

Дополнительно вы можете послать элемент формы в метод {Xhr#send}, и он
автоматически соберет все данные из формы и пошлет их на сервер.

    new Xhr('/some/url').send($('my-form'));


## Работа с JSON, :json

По умолчанию, когда {Xhr} получает ответ с сервера с типом данных JSON,
он автоматически попытается сконвертировать их в объект и установить 
свойство `responseJSON`.

    new Xhr('/some.json', {
      onSuccess: function() {
        var json = this.responseJSON;
      }
    }).send();

Вы можете отключить данную возможность установив опцию `evalJSON` в `false`


## Сокращения и поддержка DOM, :shortcuts

Существует так же несколько сокращений и дополнительных методов, для того
чтобы сделать работу с Ajax более удобной.

Во-первых вы можете использовать метод {Xhr.load} чтобы быстро создавать
GET запросы на сервер.

    Xhr.load('/some/url', {
      onSuccess: function() {
        // делаем что-то по этому поводу
      }
    });

Так же существует метод {Xhr#update} который отправляет запрос и обновляет
указанный элемент текстом ответа

    new Xhr('/some/url').update('element');

Вы так же можете проделать точно тоже самое вызвав метод элемента {Element#load}

    $('element').load('/some/url');
    
    $('element').load('/some/url', {method: 'get'});

И в конце концов вы можете отправлять ваши формы через ajax просто вызвав их
метод {Form#send}. Данный метод автоматически соберет все данные из формы,
а так же считает атрибуты `action` и `method`, и создаст соответствующий запрос
на сервер

    $('my-form').send();
    
    $('my-form').send({
      spinner: 'form-spinner',
      onSuccess: function() {
        $('notices').update(this.responseText);
      }
    });

__ВНИМАНИЕ__: этот метод работает так же если на форме есть поля с файлами
для загрузки на сервер. Если таковые обнаруживаются, то {Xhr} будет автоматически
использовать скрытый элемент IFrame, для отправки формы. Интерфейс при этом
остается тем же самым.
