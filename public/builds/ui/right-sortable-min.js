/**
 * Sortable feature for RightJS (requires the Drag'n'Drop feature)
 *
 * See http://rightjs.org/ui/sortable
 *
 * Copyright (C) Nikolay V. Nemshilov aka St.
 */
if (!Draggable) throw "Gimme Draggable";
var Sortable=new Class(Observer,{extend:{EVENTS:$w('update'),Options:{direction:'auto',tags:'li',url:null,method:'put',Xhr:{},idParam:'id',posParam:'position',parseId:true,relName:'sortable'},rescan:function(){var k=Sortable.Options.relName;var r=new RegExp('^'+k+'\\[(.+?)\\]');$$('ul[rel^="'+k+'"], ol[rel^="'+k+'"]').each(function(e){if(!e._sortable){var d=e.get('data-'+k+'-options');var o=eval('('+d+')')||{};var u=e.get('rel').match(r);if(u)o.url=u[1];new Sortable(e,o)}})}},initialize:function(e,o){this.element=$(e);this.$super(o);this.element._sortable=this.init().onUpdate('tryXhr')},destroy:function(){this.getItems.each(function(i){i.undoDraggable().undoDroppable()});delete(this.element._sortable);return this},moved:function(e){var b=this.getItems();var p=b.indexOf(e);if(p>-1&&p!=e.current_position){this.fire('update',e,p);b.each(function(a,i){a.current_position=i})}},tryXhr:function(e,a){if(this.options.url){var u=this.options.url,p={};var o=Object.merge({method:this.options.method,params:{}},this.options.Xhr);var i=e.id||'';if(this.options.parseId&&i)i=i.match(/\d+/)||'';if(u.include('%{id}'))u=u.replace('%{id}',i);else p[this.options.idParam]=i;p[this.options.posParam]=a;if(isString(o.params))o.params+='&'+Object.toQueryString(p);else o.params=Object.merge(o.params,p);Xhr.load(u,o)}},init:function(){var h=this.getItems();if(h.length){var c=this.moved.bind(this);var e=this.options.direction!='auto'?this.options.direction:['left','right'].include(h[0].getStyle('float'))?'x':'y';var f={range:this.element,axis:e,revert:true,revertDuration:0,onStop:function(){c(this.element)}};var g={overlap:e,containtment:h,onHover:function(a){var d=a.element.dimensions();var t=this.element.dimensions();var b=a.axisY?(d.top>t.top):(d.left>t.left);this.element.insert(a.clone,b?'before':'after')}};h.each(function(a,i){a.makeDraggable(f).makeDroppable(g).current_position=i})}return this},getItems:function(){return this.element.subNodes(this.options.tags)}});document.onReady(Sortable.rescan);Element.addMethods({makeSortable:function(o){new Sortable(this,o);return this},undoSortable:function(){if(this._sortable)this._sortable.destroy();return this}});