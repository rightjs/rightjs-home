/**
 * The calendar widget implemented with RightJS
 *
 * Home page: http://rightjs.org/ui/calendar
 *
 * @copyright (C) 2009 Nikolay V. Nemshilov aka St.
 */
if (!RightJS) { throw "Gimme RightJS. Please." };
var Calendar=new Class(Observer,{extend:{EVENTS:$w('show hide select done'),Options:{format:'ISO',showTime:false,showButtons:false,minDate:null,maxDate:null,firstDay:1,fxDuration:200,numberOfMonths:1,timePeriod:1,checkTags:'*',relName:'calendar'},Formats:{ISO:'%Y-%m-%d',POSIX:'%Y/%m/%d',EUR:'%d-%m-%Y',US:'%m/%d/%Y'},i18n:{Done:'Done',Now:'Now',Next:'Next Month',Prev:'Previous Month',dayNames:$w('Sunday Monday Tuesday Wednesday Thursday Friday Saturday'),dayNamesShort:$w('Sun Mon Tue Wed Thu Fri Sat'),dayNamesMin:$w('Su Mo Tu We Th Fr Sa'),monthNames:$w('January February March April May June July August September October November December'),monthNamesShort:$w('Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec')}},initialize:function(o){this.$super(o);this.element=$E('div',{'class':'right-calendar'});this.build().connectEvents().setDate(new Date())},setOptions:function(o){this.$super(o);this.options.i18n={};for(var k in this.constructor.i18n)this.options.i18n[k]=isArray(this.constructor.i18n[k])?this.constructor.i18n[k].clone():this.constructor.i18n[k];this.options.i18n=Object.merge(this.options.i18n,o||{});this.options.dayNames=this.options.i18n.dayNamesMin;if(this.options.firstDay)this.options.dayNames.push(this.options.dayNames.shift());if(!isArray(this.options.numberOfMonths))this.options.numberOfMonths=[this.options.numberOfMonths,1];if(this.options.minDate)this.options.minDate=this.parse(this.options.minDate);if(this.options.maxDate){this.options.maxDate=this.parse(this.options.maxDate);this.options.maxDate.setDate(this.options.maxDate.getDate()+1)}this.options.format=(this.constructor.Formats[this.options.format]||this.options.format).trim();return this},setDate:function(d){this.date=this.prevDate=this.parse(d);return this.update()},getDate:function(){return this.date},hide:function(){this.element.hide('fade',{duration:this.options.fxDuration});return this},show:function(p){this.element.show('fade',{duration:this.options.fxDuration});return this},insertTo:function(e,p){this.element.addClass('right-calendar-inline').insertTo(e,p);return this}});Calendar.include({update:function(d){var d=new Date(d||this.date);var a=this.element.select('div.right-calendar-month');var b=a.length;for(var i=-(b-b/2).ceil()+1;i<(b-b/2).floor()+1;i++){var m=new Date(d);m.setMonth(d.getMonth()+i);this.updateMonth(a.shift(),m)}this.updateNextPrevMonthButtons(d,b);if(this.options.showTime){this.hours.value=this.options.timePeriod<60?d.getHours():(d.getHours()/(this.options.timePeriod/60)).round()*(this.options.timePeriod/60);this.minutes.value=(d.getMinutes()/(this.options.timePeriod % 60)).round()*this.options.timePeriod}return this},updateMonth:function(f,d){d.setDate(32);var e=32-d.getDate();d.setMonth(d.getMonth()-1);var a=(this.date.getTime()/86400000).ceil();var r=f.select('tbody tr');var c=r.shift().select('td');f.select('tbody td').each(function(t){t.innerHTML='';t.className='right-calendar-day-blank'});for(var i=1;i<=e;i++){d.setDate(i);var b=d.getDay();if(this.options.firstDay)b=b?b-1:6;c[b].innerHTML=''+i;c[b].className=a==(d.getTime()/86400000).ceil()?'right-calendar-day-selected':'';if((this.options.minDate&&this.options.minDate>d)||(this.options.maxDate&&this.options.maxDate<d))c[b].className='right-calendar-day-disabled';c[b].date=new Date(d);if(b==6)c=r.shift().select('td')}f.first('div.right-calendar-month-caption').update(this.options.i18n.monthNames[d.getMonth()]+" "+d.getFullYear())},updateNextPrevMonthButtons:function(a,f){if(this.options.minDate){var b=new Date(a.getFullYear(),0,1,0,0,0);b.setMonth(a.getMonth()-(f-f/2).ceil());var c=new Date(this.options.minDate.getFullYear(),this.options.minDate.getMonth(),1,0,0,0);this.hasPrevMonth=b>=c}else this.hasPrevMonth=true;if(this.options.maxDate){var e=new Date(a);var m=new Date(this.options.maxDate);[e,m].each(function(d){d.setDate(32);d.setMonth(d.getMonth()-1);d.setDate(32-d.getDate());d.setHours(0);d.setMinutes(0);d.setSeconds(0);d.setMilliseconds(0)});this.hasNextMonth=e<m}else this.hasNextMonth=true;this.nextButton[this.hasNextMonth?'removeClass':'addClass']('right-ui-button-disabled');this.prevButton[this.hasPrevMonth?'removeClass':'addClass']('right-ui-button-disabled')},build:function(){this.buildSwaps();var g=tbody=$E('table',{'class':'right-calendar-greed'}).insertTo(this.element);if(Browser.OLD)tbody=$E('tbody').insertTo(g);for(var y=0;y<this.options.numberOfMonths[1];y++){var r=$E('tr').insertTo(tbody);for(var x=0;x<this.options.numberOfMonths[0];x++)$E('td').insertTo(r).insert(this.buildMonth())}this.buildTime();this.buildButtons();return this},buildSwaps:function(){this.prevButton=$E('div',{'class':'right-ui-button right-calendar-prev-button',html:'&lsaquo;',title:this.options.i18n.Prev}).insertTo(this.element);this.nextButton=$E('div',{'class':'right-ui-button right-calendar-next-button',html:'&rsaquo;',title:this.options.i18n.Next}).insertTo(this.element)},buildMonth:function(){return $E('div',{'class':'right-calendar-month'}).insert([$E('div',{'class':'right-calendar-month-caption'}),$E('table').insert('<thead><tr>'+this.options.dayNames.map(function(n){return '<th>'+n+'</th>'}).join('')+'</tr></thead><tbody>'+'123456'.split('').map(function(){return '<tr><td><td><td><td><td><td><td></tr>'}).join('')+'</tbody>')])},buildTime:function(){if(!this.options.showTime)return;this.hours=$E('select');this.minutes=$E('select');var m=60/this.options.timePeriod;(m==0?1:m).times(function(a){a=a*this.options.timePeriod;var c=a<10?'0'+a:a;this.minutes.insert($E('option',{value:a,html:c}))},this);var h=this.options.timePeriod>59?(24*60/this.options.timePeriod):24;(h==0?1:h).times(function(a){if(this.options.timePeriod>59)a=(a*this.options.timePeriod/60).floor();var c=a<10?'0'+a:a;this.hours.insert($E('option',{value:a,html:c}))},this);$E('div',{'class':'right-calendar-time'}).insertTo(this.element).insert([this.hours,document.createTextNode(":"),this.minutes])},buildButtons:function(){if(!this.options.showButtons)return;this.nowButton=$E('div',{'class':'right-ui-button right-calendar-now-button',html:this.options.i18n.Now});this.doneButton=$E('div',{'class':'right-ui-button right-calendar-done-button',html:this.options.i18n.Done});$E('div',{'class':'right-ui-buttons right-calendar-buttons'}).insert([this.doneButton,this.nowButton]).insertTo(this.element)}});Calendar.include({select:function(d){this.date=d;return this.fire('select',d)},done:function(){if(!this.element.hasClass('right-calendar-inline'))this.hide();return this.fire('done',this.date)},next:function(){this.prevDate=new Date(this.prevDate||this.date);if(this.hasNextMonth)this.prevDate.setMonth(this.prevDate.getMonth()+1);return this.update(this.prevDate)},prev:function(){this.prevDate=new Date(this.prevDate||this.date);if(this.hasPrevMonth)this.prevDate.setMonth(this.prevDate.getMonth()-1);return this.update(this.prevDate)},connectEvents:function(){this.prevButton.onClick(this.prev.bind(this));this.nextButton.onClick(this.next.bind(this));this.element.select('div.right-calendar-month table tbody td').each(function(c){c.onClick(function(){if(c.innerHTML!=''){var p=this.element.first('.right-calendar-day-selected');if(p)p.removeClass('right-calendar-day-selected');c.addClass('right-calendar-day-selected');this.setDay(c.date)}}.bind(this))},this);if(this.hours){this.hours.on('change',this.setTime.bind(this));this.minutes.on('change',this.setTime.bind(this))}if(this.nowButton){this.nowButton.onClick(this.setDate.bind(this,new Date()));this.doneButton.onClick(this.done.bind(this))}this.element.onClick(function(a){a.stop()});return this},setDay:function(d){this.date.setYear(d.getFullYear());this.date.setMonth(d.getMonth());this.date.setDate(d.getDate());return this.select(this.date)},setTime:function(){this.date.setHours(this.hours.value);this.date.setMinutes(this.minutes.value);return this.select(this.date)}});Calendar.include({assignTo:function(i,t){var i=$(i),t=$(t);if(t)t.onClick(function(a){a.stop();this.showAt(i.focus())}.bind(this));else i.on({focus:this.showAt.bind(this,i),click:function(a){a.stop()},keyDown:function(a){if(a.keyCode==9&&this.element.visible())this.hide()}.bind(this)});document.onClick(this.hide.bind(this));return this},showAt:function(e){var e=$(e),d=e.dimensions();this.setDate(this.parse(e.value));if(RightJS.version<'1.4.1'){if(Browser.WebKit){d.left+=document.body.scrolls().x;d.top+=document.body.scrolls().y}else if(Browser.Konqueror){d.left=e.offsetLeft;d.top=e.offsetTop}}this.element.setStyle({position:'absolute',margin:'0',left:(d.left)+'px',top:(d.top+d.height)+'px'}).insertTo(document.body);this.stopObserving('select').stopObserving('done');this.on(this.doneButton?'done':'select',function(){e.value=this.format()}.bind(this));return this.hideOthers().show()},toggleAt:function(i){if(this.element.parentNode&&this.element.visible())this.hide();else this.showAt(i);return this},hideOthers:function(){$$('div.right-calendar').each(function(e){if(!e.hasClass('right-calendar-inline')){if(e!=this.element)e.hide()}});return this}});Calendar.include({parse:function(g){var d;if(g instanceof Date||Date.parse(g))d=new Date(g);else if(isString(g)&&g){var t=RegExp.escape(this.options.format);var h=t.match(/%[a-z]/ig).map('match',/[a-z]$/i).map('first').without('%');var r=new RegExp('^'+t.replace(/%p/i,'(pm|PM|am|AM)').replace(/(%[a-z])/ig,'(.+?)')+'$');var m=g.trim().match(r);if(m){m.shift();var y=null,f=null,d=null,b=null,e=null,s=null,c;while(m.length){var v=m.shift();var k=h.shift();if(k.toLowerCase()=='b')f=this.options.i18n[k=='b'?'monthNamesShort':'monthNames'].indexOf(v);else if(k.toLowerCase()=='p')c=v.toLowerCase();else{v=v.toInt();switch(k){case 'd':case 'e':d=v;break;case 'm':f=v-1;break;case 'y':case 'Y':y=v;break;case 'H':case 'k':case 'I':case 'l':b=v;break;case 'M':e=v;break;case 'S':s=v;break}}}if(c){b=b==12?0:b;b=(c=='pm'?b+12:b)}d=new Date(y,f,d,b,e,s)}}else d=new Date();return d},format:function(g){var j=this.options.i18n;var f=this.date.getDay();var q=this.date.getMonth();var c=this.date.getDate();var t=this.date.getFullYear();var h=this.date.getHours();var o=this.date.getMinutes();var s=this.date.getSeconds();var i=(h==0?12:h<13?h:h-12);var v={a:j.dayNamesShort[f],A:j.dayNames[f],b:j.monthNamesShort[q],B:j.monthNames[q],d:(c<10?'0':'')+c,e:''+c,m:(q<9?'0':'')+(q+1),y:(''+t).substring(2,4),Y:''+t,H:(h<10?'0':'')+h,k:''+h,I:(h>0&&(h<10||(h>12&&h<22))?'0':'')+i,l:''+i,p:h<12?'AM':'PM',P:h<12?'am':'pm',M:(o<10?'0':'')+o,S:(s<10?'0':'')+s,'%':'%'};var r=g||this.options.format;for(var n in v)r=r.replace('%'+n,v[n]);return r}});document.onReady(function(){var c=new Calendar();var a=new RegExp(Calendar.Options.relName+'\\[(.+?)\\]');$$(Calendar.Options.checkTags+'[rel*='+Calendar.Options.relName+']').each(function(e){var r=e.get('rel').match(a);if(r){var i=$(r[1]);if(i)c.assignTo(i,e)}else c.assignTo(e)})});document.write("<style type=\"text/css\">*.right-ui-button{display:inline-block;*display:inline;*zoom:1;height:1em;line-height:1em;padding:.2em .5em;text-align:center;border:1px solid #CCC;border-radius:.2em;-moz-border-radius:.2em;-webkit-border-radius:.2em;cursor:pointer;color:#555;background-color:#FFF}*.right-ui-button:hover{color:#222;border-color:#BA8;background-color:#FB6}*.right-ui-button-disabled,*.right-ui-button-disabled:hover{color:#888;background:#EEE;border-color:#CCC;cursor:default}*.right-ui-buttons{margin-top:.5em}div.right-calendar{position:absolute;height:auto;border:1px solid #BBB;position:relative;padding:.5em;border-radius:.3em;-moz-border-radius:.3em;-webkit-border-radius:.3em;cursor:default;background-color:#EEE;-moz-box-shadow:.2em .4em .8em #666;-webkit-box-shadow:.2em .4em .8em #666}div.right-calendar-inline{position:relative;display:inline-block;*display:inline;*zoom:1;-moz-box-shadow:none;-webkit-box-shadow:none}div.right-calendar-prev-button,div.right-calendar-next-button{position:absolute;float:left;width:1em;padding:.15em .4em}div.right-calendar-next-button{right:.5em}div.right-calendar-month-caption{text-align:center;height:1.2em;line-height:1.2em}table.right-calendar-greed{border-spacing:0px;border:none;background:none;width:auto}table.right-calendar-greed td{vertical-align:top;border:none;background:none;margin:0;padding:0;padding-right:.4em}table.right-calendar-greed td:last-child{padding:0}div.right-calendar-month table{margin:0;padding:0;border:none;width:auto;margin-top:.2em;border-spacing:1px;border-collapse:separate;border:none;background:none}div.right-calendar-month table th{color:#777;text-align:center;border:none;background:none;padding:0;margin:0}div.right-calendar-month table td,div.right-calendar-month table td:last-child{text-align:right;padding:.1em .3em;background-color:#FFF;border:1px solid #CCC;cursor:pointer;border-radius:.2em;-moz-border-radius:.2em;-webkit-border-radius:.2em}div.right-calendar-month table td:hover{background-color:#FB6;border-color:#BA8}div.right-calendar-month table td.right-calendar-day-blank{background:transparent;cursor:default;border:none}div.right-calendar-month table td.right-calendar-day-selected{background-color:#FB6;border-color:#BA8;color:brown}div.right-calendar-month table td.right-calendar-day-disabled{color:#888;background:#EEE;border-color:#CCC;cursor:default}div.right-calendar-time{text-align:center}div.right-calendar-time select{margin:0 .4em}div.right-calendar-buttons div.right-ui-button{width:3.2em}div.right-calendar-done-button{position:absolute;right:.5em}</style>");